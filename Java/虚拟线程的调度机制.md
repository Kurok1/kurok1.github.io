# çº¿ç¨‹è°ƒåº¦çš„å†å²å‘å±•æµç¨‹
**â€œè½½ä½“çº¿ç¨‹å¿…é¡»æ¥è‡ªæŸä¸ªçº¿ç¨‹æä¾›è€…ï¼ˆè°ƒåº¦å™¨/æ‰§è¡Œå™¨ï¼‰â€è¿™ä¸€æ€æƒ³åœ¨ JDK 21 ä¹‹å‰å°±å·²ç»å­˜åœ¨**ï¼›è™šæ‹Ÿçº¿ç¨‹å¹¶ä¸æ˜¯å‡­ç©ºå¼•å…¥è¿™ä¸€æ¨¡å‹ï¼Œè€Œæ˜¯ **åœ¨æ—¢æœ‰å¹¶å‘ä¸è°ƒåº¦è®¾è®¡ä¹‹ä¸Šï¼ŒæŠŠâ€œçº¿ç¨‹â€è¿™ä¸€æ¦‚å¿µæ‹†åˆ†å¾—æ›´å½»åº•**ã€‚ä¸è¿‡ï¼Œéœ€è¦å¼ºè°ƒçš„æ˜¯ï¼š

> **ä»¥å‰ç‰ˆæœ¬ä¸­â€œçº¿ç¨‹æä¾›è€…â€çš„å­˜åœ¨æ˜¯â€œéšå¼çš„â€ï¼Œè€Œåœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­å˜æˆäº†â€œæ˜¾å¼ä¸”å…³é”®çš„â€ã€‚**

ä¸‹é¢æŒ‰æ—¶é—´å’Œå±‚çº§ç³»ç»Ÿæ¢³ç†ã€‚

---

## ä¸€ã€æœ€æ—©çš„åŸå‹ï¼šExecutorï¼ˆJDK 5ï¼‰

### 1. Executor æœ¬èº«å°±æ˜¯â€œçº¿ç¨‹æä¾›è€…â€æŠ½è±¡

JDK 5ï¼ˆJava 5ï¼‰å¼•å…¥ï¼š

```java
java.util.concurrent.Executor
```

å…¶è¯­ä¹‰å¹¶ä¸æ˜¯â€œæ‰§è¡Œä»»åŠ¡â€ï¼Œè€Œæ˜¯ï¼š

> **ä¸ºä»»åŠ¡æä¾›æ‰§è¡Œæ‰€éœ€çš„çº¿ç¨‹èµ„æº**

åœ¨ JDK æ–‡æ¡£ä¸­ï¼ŒExecutor è¢«å®šä¹‰ä¸ºï¼š

- è§£è€¦ **ä»»åŠ¡æäº¤** ä¸ **ä»»åŠ¡æ‰§è¡Œ**
    
- å±è”½çº¿ç¨‹åˆ›å»ºã€å¤ç”¨ã€è°ƒåº¦ç­–ç•¥
    

è¿™å®é™…ä¸Šå·²ç»ç¡®ç«‹äº†ä¸€ä¸ªæ ¸å¿ƒæ€æƒ³ï¼š

> **ä»»åŠ¡æœ¬èº«ä¸å…³å¿ƒçº¿ç¨‹æ¥è‡ªå“ªé‡Œ**

---

### 2. åœ¨å¹³å°çº¿ç¨‹æ—¶ä»£ï¼šå…³ç³»æ˜¯åè¿‡æ¥çš„

åœ¨ Java 5 ~ Java 20ï¼š

```text
Runnable / Callable
   â†“
Executor
   â†“
Platform Thread (OS Thread)
```

- **ä»»åŠ¡æ˜¯è½»é‡çš„**
    
- **çº¿ç¨‹æ˜¯é‡é‡çº§çš„**
    
- Executor ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ
    

æ­¤æ—¶è¿˜æ²¡æœ‰â€œçº¿ç¨‹è·‘åœ¨çº¿ç¨‹ä¸Šâ€çš„æ¦‚å¿µã€‚

---

## äºŒã€ForkJoinPoolï¼šç¬¬ä¸€æ¬¡â€œè°ƒåº¦å™¨åŒ–â€çš„çº¿ç¨‹æ¨¡å‹ï¼ˆJava 7ï¼‰

### 1. ForkJoinWorkerThread çš„ç‰¹æ®Šæ€§

`ForkJoinPool`ï¼ˆJava 7ï¼‰å·²ç»å…·å¤‡ä»¥ä¸‹ç‰¹å¾ï¼š

- çº¿ç¨‹ä¸æ˜¯â€œä¸€ä»»åŠ¡ä¸€çº¿ç¨‹â€
    
- çº¿ç¨‹åå¤æ‰§è¡Œå¤šä¸ªä»»åŠ¡
    
- æ”¯æŒ **work-stealing**
    

æ›´é‡è¦çš„æ˜¯ï¼š

```text
ForkJoinTask
   â†“
ForkJoinPool (Scheduler)
   â†“
ForkJoinWorkerThread
```

è¿™é‡Œå·²ç»å‡ºç°äº†**â€œè°ƒåº¦å™¨ â†’ å·¥ä½œè€…çº¿ç¨‹â€**çš„æ˜ç¡®åˆ†å±‚ã€‚

---

### 2. ManagedBlockerï¼šå…³é”®çš„å†å²ä¼ç¬”

Java 8 å¼•å…¥ï¼š

```java
ForkJoinPool.ManagedBlocker
```

ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ

> **å‘Šè¯‰è°ƒåº¦å™¨ï¼šå½“å‰ä»»åŠ¡è¦é˜»å¡äº†ï¼Œä½ å¯èƒ½éœ€è¦è¡¥å……çº¿ç¨‹**

è¿™æ˜¯éå¸¸å…³é”®çš„ä¸€æ­¥ï¼Œå› ä¸ºå®ƒæ„å‘³ç€ï¼š

- é˜»å¡ä¸å†æ˜¯â€œçº¿ç¨‹ç§äº‹â€
    
- é˜»å¡éœ€è¦é€šçŸ¥è°ƒåº¦å™¨
    
- è°ƒåº¦å™¨è´Ÿè´£çº¿ç¨‹è¡¥å¿
    

ğŸ‘‰ è¿™åœ¨è¯­ä¹‰ä¸Šå·²ç»éå¸¸æ¥è¿‘è™šæ‹Ÿçº¿ç¨‹çš„ **unmount / remount** æ€æƒ³ã€‚

---

## ä¸‰ã€CompletableFutureï¼šä»»åŠ¡å½»åº•ä¸çº¿ç¨‹è§£ç»‘ï¼ˆJava 8ï¼‰

### 1. é»˜è®¤ Executor çš„å¼•å…¥

```java
CompletableFuture.supplyAsync(() -> ...)
```

å¦‚æœä½ ä¸ä¼  Executorï¼š

- é»˜è®¤ä½¿ç”¨ `ForkJoinPool.commonPool()`
    

è¿™é‡Œä½“ç°çš„æ˜¯ï¼š

> **å¼‚æ­¥è®¡ç®—æœ¬èº«ä¸å†æ‹¥æœ‰çº¿ç¨‹ï¼Œçº¿ç¨‹ç”± Executor æä¾›**

---

### 2. continuation ä¸æ˜¯åœ¨â€œå½“å‰çº¿ç¨‹â€è¿è¡Œ

CompletableFuture çš„ thenApply / thenComposeï¼š

- å¯èƒ½åœ¨ä¸åŒçº¿ç¨‹è¿è¡Œ
    
- å®Œå…¨ç”± Executor å†³å®š
    

è¿™å·²ç»æ˜¯â€œæ‰§è¡Œä¸Šä¸‹æ–‡æ¼‚ç§»â€çš„æ—©æœŸå½¢å¼ã€‚

---

## å››ã€Project Loom ä¹‹å‰ï¼šå·²ç»å­˜åœ¨çš„â€œå‡†è½½ä½“çº¿ç¨‹â€æ¨¡å¼

åœ¨ Loom ä¹‹å‰ï¼ŒJava ä¸­å·²ç»å­˜åœ¨è‹¥å¹²â€œç±»è½½ä½“â€å…³ç³»ï¼š

### 1. Netty EventLoop

```text
Task
   â†“
EventLoop
   â†“
Single Thread
```

- ä»»åŠ¡ä¸æ„ŸçŸ¥çº¿ç¨‹
    
- çº¿ç¨‹æ˜¯è°ƒåº¦å™¨çš„èµ„æº
    

---

### 2. Akka / Actor æ¨¡å‹

```text
Message
   â†“
Dispatcher
   â†“
Thread Pool
```

Actor ä»æ¥ä¸â€œæ‹¥æœ‰çº¿ç¨‹â€ã€‚

---

## äº”ã€è™šæ‹Ÿçº¿ç¨‹çš„çœŸæ­£åˆ›æ–°ç‚¹åœ¨å“ªé‡Œï¼Ÿ

### 1. é¦–æ¬¡æŠŠâ€œçº¿ç¨‹â€ä¹Ÿå˜æˆäº†è¢«è°ƒåº¦å¯¹è±¡

åœ¨ JDK 21 ä¹‹å‰ï¼š

|è¢«è°ƒåº¦å¯¹è±¡|æ˜¯ä»€ä¹ˆ|
|---|---|
|Runnable|æ˜¯|
|Callable|æ˜¯|
|ForkJoinTask|æ˜¯|
|CompletableFuture|æ˜¯|
|**Thread**|âŒ å¦|

è€Œåœ¨ JDK 21ï¼š

```text
VirtualThread
   â†“ scheduled by
Executor
   â†“ runs on
Platform Thread
```

è¿™æ˜¯ç¬¬ä¸€æ¬¡ï¼š

> **çº¿ç¨‹æœ¬èº«æˆä¸ºè°ƒåº¦å™¨çš„â€œä»»åŠ¡â€**

---

### 2. Executor ä»â€œä»»åŠ¡è°ƒåº¦å™¨â€å‡çº§ä¸ºâ€œçº¿ç¨‹è°ƒåº¦å™¨â€

ä»¥å‰ï¼š

```text
Executor schedules tasks
```

ç°åœ¨ï¼š

```text
Executor schedules virtual threads (which execute code)
```

ä½† Executor æ¥å£**æ²¡æœ‰å˜åŒ–**ï¼Œè¿™æ­£æ˜¯è®¾è®¡çš„é«˜æ˜ä¹‹å¤„ã€‚

---

## å…­ã€ç»“è®ºï¼šä¸æ˜¯æ–°æ¦‚å¿µï¼Œè€Œæ˜¯â€œç»ˆæå½¢æ€â€

### ç²¾å‡†ç»“è®º

- âœ… **â€œçº¿ç¨‹æä¾›è€…â€è¿™ä¸€è§’è‰²åœ¨ JDK 5 å°±å·²ç»å­˜åœ¨**
    
- âœ… **ForkJoinPool å·²ç»éƒ¨åˆ†å…·å¤‡è½½ä½“çº¿ç¨‹çš„é›å½¢**
    
- âŒ **ä½†åœ¨ JDK 21 ä¹‹å‰ï¼Œæ²¡æœ‰â€œçº¿ç¨‹è¿è¡Œåœ¨çº¿ç¨‹ä¹‹ä¸Šâ€çš„æ¨¡å‹**
    

### è™šæ‹Ÿçº¿ç¨‹çš„æœ¬è´¨åˆ›æ–°

> **æŠŠâ€œçº¿ç¨‹â€é™æ ¼ä¸ºä¸€ç§å¯è¢«è°ƒåº¦ã€å¯è¢«æŒ‚èµ·çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œè€Œ Executor åˆ™è‡ªç„¶æˆä¸ºå®ƒçš„æä¾›è€…ä¸è°ƒåº¦å™¨ã€‚**


# ä¸ºä»€ä¹ˆåœ¨å®ç°ä¸­éœ€è¦ç»‘å®šä¸€ä¸ªè°ƒåº¦å™¨
åœ¨ **JDK 21** ä¸­ï¼Œ**è™šæ‹Ÿçº¿ç¨‹ï¼ˆVirtual Threadï¼‰** ä¹‹æ‰€ä»¥åœ¨å®ç°ä¸Šè¦**ç»‘å®šä¸€ä¸ª `Executor`**ï¼Œå¹¶ä¸æ˜¯ä¸ºäº†â€œå¤šæ­¤ä¸€ä¸¾â€ï¼Œè€Œæ˜¯å‡ºäº **è°ƒåº¦æ¨¡å‹ã€ä¸ç°æœ‰å¹¶å‘æ¡†æ¶çš„å…¼å®¹æ€§ï¼Œä»¥åŠè¿è¡Œæ—¶å¯æ§æ€§** ç­‰å¤šä¸ªæ–¹é¢çš„å¿…ç„¶è®¾è®¡é€‰æ‹©ã€‚ä¸‹é¢ä»å®ç°æœºåˆ¶å±‚é¢ç³»ç»Ÿè¯´æ˜åŸå› ã€‚

---

## ä¸€ã€è™šæ‹Ÿçº¿ç¨‹æœ¬è´¨ä¸Šä»ç„¶éœ€è¦â€œæ‰¿è½½è€…â€

### 1. è™šæ‹Ÿçº¿ç¨‹ â‰  è‡ªè¡Œè¿è¡Œçš„çº¿ç¨‹

è™šæ‹Ÿçº¿ç¨‹æ˜¯ **ç”± JVM è°ƒåº¦çš„ç”¨æˆ·æ€çº¿ç¨‹**ï¼Œå®ƒæœ¬èº«**ä¸ç›´æ¥è¿è¡Œåœ¨ CPU ä¸Š**ï¼Œè€Œæ˜¯ï¼š

- **è¿è¡Œåœ¨æŸä¸ªè½½ä½“çº¿ç¨‹ï¼ˆCarrier Threadï¼‰ä¸Š**
    
- è½½ä½“çº¿ç¨‹æœ¬è´¨æ˜¯ä¸€ä¸ª **å¹³å°çº¿ç¨‹ï¼ˆOS Threadï¼‰**
    

> è™šæ‹Ÿçº¿ç¨‹åªæè¿° _æ‰§è¡Œä¸Šä¸‹æ–‡_ï¼Œå¹¶ä¸æ‹¥æœ‰çœŸå®çš„æ‰§è¡Œèµ„æºã€‚

### 2. è½½ä½“çº¿ç¨‹ä»å“ªé‡Œæ¥ï¼Ÿ

è½½ä½“çº¿ç¨‹çš„æ¥æºå¿…é¡»æ˜¯ä¸€ä¸ª **çº¿ç¨‹æä¾›è€…**ï¼Œåœ¨ Java é‡Œè¿™ä¸ªè§’è‰²å¤©ç„¶å°±æ˜¯ï¼š

- `Executor`
    
- ç‰¹åˆ«æ˜¯ `ForkJoinPool` è¿™ç§å·¥ä½œçªƒå–è°ƒåº¦å™¨
    

å› æ­¤ï¼Œ**è™šæ‹Ÿçº¿ç¨‹å¿…é¡»ç»‘å®šä¸€ä¸ª `Executor`ï¼Œç”¨æ¥æä¾›å’Œç®¡ç†è½½ä½“çº¿ç¨‹**ã€‚

---

## äºŒã€Executor æ˜¯è™šæ‹Ÿçº¿ç¨‹çš„â€œè°ƒåº¦å™¨æŠ½è±¡â€

### 1. è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦æ¨¡å‹ï¼ˆç®€åŒ–ï¼‰

```text
VirtualThread
   â†“ mount
Carrier Thread (Platform Thread)
   â†“ execute
CPU
```

å½“è™šæ‹Ÿçº¿ç¨‹ï¼š

- å¯åŠ¨
    
- è¢« `unpark`
    
- ä»é˜»å¡ I/O ä¸­æ¢å¤
    

éƒ½éœ€è¦ **é‡æ–°æäº¤åˆ°æŸä¸ªè°ƒåº¦å™¨æ‰§è¡Œ**ã€‚

è¿™ä¸ªâ€œè°ƒåº¦å™¨â€åœ¨ Java ä¸­å¹¶ä¸æ˜¯ç¡¬ç¼–ç çš„ï¼Œè€Œæ˜¯é€šè¿‡ **`Executor` æŠ½è±¡**å®Œæˆçš„ã€‚

---

## ä¸‰ã€ä¸ºä»€ä¹ˆä¸è®© JVM è‡ªå·±ç®¡ç†çº¿ç¨‹æ± ï¼Ÿ

### æ ¸å¿ƒåŸå› ï¼š**æ§åˆ¶æƒä¸å¯ç»„åˆæ€§**

#### 1. Executor æ˜¯ Java å¹¶å‘çš„â€œäº‹å®æ ‡å‡†æ¥å£â€

- `CompletableFuture`
    
- `StructuredTaskScope`
    
- `Executors.newVirtualThreadPerTaskExecutor()`
    
- å„ç§æ¡†æ¶ï¼ˆSpringã€Nettyã€Quarkusï¼‰
    

å…¨éƒ¨å›´ç»• `Executor` æ„å»ºã€‚

> è®©è™šæ‹Ÿçº¿ç¨‹ç»‘å®š Executorï¼Œå¯ä»¥ **æ— ç¼èå…¥ç°æœ‰ç”Ÿæ€**ã€‚

---

#### 2. Executor æä¾›å…³é”®çš„â€œç­–ç•¥æ³¨å…¥ç‚¹â€

é€šè¿‡ Executorï¼Œå¯ä»¥æ§åˆ¶ï¼š

|èƒ½åŠ›|è¯´æ˜|
|---|---|
|å¹¶è¡Œåº¦|é™åˆ¶è½½ä½“çº¿ç¨‹æ•°é‡|
|è°ƒåº¦ç­–ç•¥|FIFO / Work-Stealing|
|èµ„æºéš”ç¦»|ä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒ Executor|
|å¯è§‚æµ‹æ€§|ç›‘æ§ã€ç»Ÿè®¡ã€Tracing|

å¦‚æœè™šæ‹Ÿçº¿ç¨‹ç”± JVM å…¨æƒç®¡ç†ï¼Œè¿™äº›èƒ½åŠ›å°†æ— æ³•æš´éœ²ã€‚

---

## å››ã€é»˜è®¤æƒ…å†µä¸‹ç»‘å®šçš„æ˜¯ä»€ä¹ˆ Executorï¼Ÿ

### JDK 21 é»˜è®¤è¡Œä¸º

```java
Thread.ofVirtual().start(() -> { ... });
```

èƒŒåç»‘å®šçš„æ˜¯ï¼š

```text
ForkJoinPool
  â””â”€â”€ VirtualThreadScheduler
```

ç‰¹å¾ï¼š

- **å…±äº«å…¨å±€è°ƒåº¦å™¨**
    
- å¹¶è¡Œåº¦ â‰ˆ `Runtime.getRuntime().availableProcessors()`
    
- ä»…ç”¨äºæ‰¿è½½è™šæ‹Ÿçº¿ç¨‹çš„æ‰§è¡Œç‰‡æ®µ
    

> è¿™æ˜¯ä¸€ä¸ª **ä¸“é—¨ä¸ºè™šæ‹Ÿçº¿ç¨‹è®¾è®¡çš„è°ƒåº¦å™¨**ï¼Œä½†ä»ç„¶å®ç°ä¸º `Executor`ã€‚

---

## äº”ã€ä¸ºä»€ä¹ˆè™šæ‹Ÿçº¿ç¨‹ä¸èƒ½â€œè‡ªå·±é˜»å¡è‡ªå·±â€ï¼Ÿ

### å…³é”®ç‚¹ï¼š**æŒ‚èµ·ï¼ˆparkï¼‰â‰  å ç”¨çº¿ç¨‹**

å½“è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œåˆ°ï¼š

- `LockSupport.park()`
    
- é˜»å¡ I/O
    
- `synchronized` ç­‰
    

JVM ä¼šï¼š

1. **å¸è½½è™šæ‹Ÿçº¿ç¨‹ï¼ˆunmountï¼‰**
    
2. **é‡Šæ”¾è½½ä½“çº¿ç¨‹å› Executor**
    
3. ç­‰å¾…äº‹ä»¶å®Œæˆ
    
4. **é‡æ–°æäº¤è™šæ‹Ÿçº¿ç¨‹åˆ° Executor**
    

æ²¡æœ‰ Executorï¼Œå°±æ— æ³•å®Œæˆè¿™ä¸€ç”Ÿå‘½å‘¨æœŸé—­ç¯ã€‚

---

## å…­ã€ä¸ Structured Concurrency çš„å…³ç³»

`StructuredTaskScope` ç¤ºä¾‹ï¼š

```java
try (var scope = new StructuredTaskScope.ShutdownOnFailure()) {
    Future<A> fa = scope.fork(taskA);
    Future<B> fb = scope.fork(taskB);
    scope.join();
}
```

å…¶å†…éƒ¨æœºåˆ¶æ˜¯ï¼š

- å°†æ¯ä¸ªä»»åŠ¡æäº¤åˆ° **è™šæ‹Ÿçº¿ç¨‹ Executor**
    
- Executor å†³å®šå®é™…è½½ä½“çº¿ç¨‹è°ƒåº¦
    

è¿™ä½¿å¾—ï¼š

- ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸå¯æ§
    
- å–æ¶ˆã€å¤±è´¥ä¼ æ’­å¯ç»Ÿä¸€å¤„ç†
    

---

## ä¸ƒã€æ€»ç»“ï¼šç»‘å®š Executor æ˜¯â€œå¿…ç„¶è®¾è®¡â€ï¼Œä¸æ˜¯å®ç°å¦¥å

### ä¸€å¥è¯ç»“è®º

> **è™šæ‹Ÿçº¿ç¨‹ç»‘å®š Executorï¼Œæ˜¯ä¸ºäº†æŠŠâ€œæ‰§è¡Œèµ„æºç®¡ç†â€ä¸â€œæ‰§è¡Œä¸Šä¸‹æ–‡â€è§£è€¦ã€‚**

### æ ¸å¿ƒåŸå› æ±‡æ€»

|åŸå› |è¯´æ˜|
|---|---|
|è™šæ‹Ÿçº¿ç¨‹ä¸æ‹¥æœ‰ CPU|å¿…é¡»è¿è¡Œåœ¨å¹³å°çº¿ç¨‹ä¸Š|
|Executor æ˜¯çº¿ç¨‹èµ„æºæŠ½è±¡|æä¾›è½½ä½“çº¿ç¨‹|
|è°ƒåº¦éœ€è¦å¯æ§|å¹¶è¡Œåº¦ã€éš”ç¦»ã€ç­–ç•¥|
|ç”Ÿæ€å…¼å®¹æ€§|æ— ç¼æ¥å…¥ç°æœ‰å¹¶å‘æ¡†æ¶|
|æ”¯æŒæŒ‚èµ·/æ¢å¤|park/unpark ç”Ÿå‘½å‘¨æœŸ|

# è°ƒåº¦è¿‡ç¨‹æ˜¯å¦å°±æ˜¯è™šæ‹Ÿçº¿ç¨‹åˆ›å»ºçš„è¿‡ç¨‹ï¼Ÿ

## ä¸€ã€å…ˆç»™å‡ºæœ€é‡è¦çš„å¦å®šç»“è®º

> âŒ **JVM å¹¶æ²¡æœ‰â€œé¢„å…ˆåˆ›å»ºä¸€æ‰¹è™šæ‹Ÿçº¿ç¨‹â€**  
> âŒ **`Executor` ä¹Ÿä¸ä¼šæŠŠä»»åŠ¡â€œè°ƒåº¦åˆ°æŸä¸ªç©ºé—²çš„è™šæ‹Ÿçº¿ç¨‹ä¸Šâ€**  
> âŒ **è™šæ‹Ÿçº¿ç¨‹ä¸æ˜¯æ± åŒ–çš„ï¼Œä¹Ÿä¸å­˜åœ¨å¤ç”¨**

**æ¯ä¸€ä¸ª `Thread.ofVirtual().start(...)` éƒ½åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„è™šæ‹Ÿçº¿ç¨‹å¯¹è±¡ã€‚**

---

## äºŒã€â€œè°ƒåº¦â€çš„å¯¹è±¡æ˜¯è°

### å¹³å°çº¿ç¨‹æ—¶ä»£ï¼ˆä½ ç†Ÿæ‚‰çš„ï¼‰

```text
Runnable
   â†“ (schedule)
Executor
   â†“
Platform Thread (OS Thread)
```

- è¢«è°ƒåº¦çš„æ˜¯ **ä»»åŠ¡ï¼ˆRunnableï¼‰**
    
- çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æº
    
- çº¿ç¨‹éœ€è¦å¤ç”¨ï¼ˆçº¿ç¨‹æ± ï¼‰
    

---

### è™šæ‹Ÿçº¿ç¨‹æ—¶ä»£ï¼ˆå…³é”®åè½¬ï¼‰

```text
VirtualThread (implements Runnable)
   â†“ (schedule)
Executor  â† myExecutor
   â†“
Platform Thread (Carrier Thread)
```

> **è¢«è°ƒåº¦çš„å¯¹è±¡ä¸å†æ˜¯â€œä¸šåŠ¡ä»»åŠ¡â€ï¼Œè€Œæ˜¯â€œè™šæ‹Ÿçº¿ç¨‹æœ¬èº«â€ã€‚**

è¿™å¥è¯å¦‚æœä½ åªè®°ä¸€å¥ï¼Œè¯·è®°è¿™ä¸€å¥ã€‚

---

## ä¸‰ã€`Executor` åˆ°åº•åœ¨â€œè°ƒåº¦ä»€ä¹ˆâ€ï¼Ÿ

### ç²¾å‡†ç­”æ¡ˆ

> **`Executor` è°ƒåº¦çš„æ˜¯ï¼š  
> ã€ŒæŸä¸ªè™šæ‹Ÿçº¿ç¨‹çš„ä¸‹ä¸€æ®µè¿è¡Œæ—¶é—´ç‰‡ã€**

ä¸æ˜¯è™šæ‹Ÿçº¿ç¨‹æ± ï¼Œä¸æ˜¯ä»»åŠ¡æ± ï¼Œä¸æ˜¯å¤ç”¨ã€‚

---

## å››ã€æ‹†è§£è¿™è¡Œä»£ç åœ¨ JVM é‡Œå‘ç”Ÿäº†ä»€ä¹ˆ

```java
Thread.ofVirtual().scheduler(myExecutor).start(() -> {
    doSomething();
});
```

### Step 1ï¼šåˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼ˆä¸€æ¬¡æ€§çš„ï¼‰

```text
new VirtualThread(
    task = doSomething,
    scheduler = myExecutor
)
```

æ­¤æ—¶ï¼š

- è™šæ‹Ÿçº¿ç¨‹å¯¹è±¡å­˜åœ¨äº†
    
- æœ‰ç‹¬ç«‹æ ˆã€Continuation
    
- **è¿˜æ²¡è¿è¡Œ**
    

---

### Step 2ï¼šå¯åŠ¨è™šæ‹Ÿçº¿ç¨‹

```text
scheduler.execute(virtualThread)
```

æ³¨æ„ï¼š

- `virtualThread` æœ¬èº«å°±æ˜¯ä¸€ä¸ª `Runnable`
    
- `Executor` æ ¹æœ¬ä¸çŸ¥é“è¿™æ˜¯â€œçº¿ç¨‹â€
    

---

### Step 3ï¼šExecutor åšå®ƒä¸€è´¯åšçš„äº‹

```text
myExecutor:
  - é€‰ä¸€ä¸ªç©ºé—²çš„ OS çº¿ç¨‹
  - è°ƒç”¨ runnable.run()
```

è¿™ä¸ª `run()` å®é™…æ˜¯ï¼š

```java
VirtualThread.run()
```

---

### Step 4ï¼šè™šæ‹Ÿçº¿ç¨‹è¿è¡Œ + å¯èƒ½æŒ‚èµ·

```text
VirtualThread.run()
   â†“
Continuation.run()
   â†“
doSomething()
```

å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼š

- I/O é˜»å¡
    
- park()
    
- sleep()
    

é‚£ä¹ˆï¼š

1. **è™šæ‹Ÿçº¿ç¨‹è¢«æŒ‚èµ·ï¼ˆunmountï¼‰**
    
2. **OS çº¿ç¨‹ç«‹å³å½’è¿˜ç»™ Executor**
    
3. è™šæ‹Ÿçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€
    

---

### Step 5ï¼šæ¢å¤æ—¶å†æ¬¡â€œè¢«è°ƒåº¦â€

å½“ I/O å®Œæˆï¼š

```text
scheduler.execute(virtualThread)
```

**è¿˜æ˜¯åŒä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹å¯¹è±¡**

---

## äº”ã€ç°åœ¨å›ç­”æœ€æ ¸å¿ƒçš„è¯¯è§£ç‚¹

> **â€œæ˜¯ä¸æ˜¯ JVM å†…éƒ¨å·²ç»åˆ›å»ºäº†ä¸€æ‰¹è™šæ‹Ÿçº¿ç¨‹ï¼Œç„¶åé€šè¿‡ myExecutor è°ƒåº¦åˆ°ç©ºé—²çš„è™šæ‹Ÿçº¿ç¨‹ä¸Šï¼Ÿâ€**

### æ˜ç¡®å›ç­”ï¼š**å®Œå…¨ä¸æ˜¯**

|é¡¹ç›®|çœŸå®æƒ…å†µ|
|---|---|
|è™šæ‹Ÿçº¿ç¨‹æ˜¯å¦æ± åŒ–|âŒ å¦|
|æ˜¯å¦å¤ç”¨è™šæ‹Ÿçº¿ç¨‹|âŒ å¦|
|Executor æ˜¯å¦ç®¡ç†è™šæ‹Ÿçº¿ç¨‹æ•°é‡|âŒ å¦|
|Executor ç®¡ç†çš„æ˜¯ä»€ä¹ˆ|âœ… OS çº¿ç¨‹|
|è™šæ‹Ÿçº¿ç¨‹çš„æ•°é‡è°å†³å®š|âœ… ä½ çš„ `newVirtualThread` è°ƒç”¨æ¬¡æ•°|

---

## å…­ã€é‚£â€œè°ƒåº¦â€çš„æ„ä¹‰åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

### ä¸€å¥è¯ç‰ˆï¼ˆè¯·è®¤çœŸè¯»ï¼‰

> **è°ƒåº¦çš„æ„ä¹‰æ˜¯ï¼š  
> å†³å®šâ€œæŸä¸ªè™šæ‹Ÿçº¿ç¨‹çš„æŸä¸€æ®µä»£ç ï¼Œåœ¨å“ªä¸ª OS çº¿ç¨‹ä¸Šè¿è¡Œâ€ã€‚**

---

### å†æ¢ä¸€ç§æ›´ç›´è§‰çš„è¯´æ³•

è™šæ‹Ÿçº¿ç¨‹æ˜¯ï¼š

> **â€œå¯æš‚åœã€å¯æ¢å¤çš„æ‰§è¡Œè¿‡ç¨‹â€**

Executor çš„èŒè´£æ˜¯ï¼š

> **â€œç»™è¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹æ‰¾ä¸€ä¸ªä¸´æ—¶çš„ CPU æ‰¿è½½è€…â€**

---

## ä¸ƒã€ä¸ºä»€ä¹ˆè¿™ä¸ªè®¾è®¡æå…¶é‡è¦ï¼Ÿ

å¦‚æœæ²¡æœ‰è¿™ç§è°ƒåº¦æœºåˆ¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

### å‡è®¾è™šæ‹Ÿçº¿ç¨‹ç›´æ¥ç»‘å®š OS çº¿ç¨‹

```text
VirtualThread â†’ å›ºå®š OS Thread
```

é‚£å°±æ„å‘³ç€ï¼š

- ä¸€é˜»å¡å°±æµªè´¹ OS çº¿ç¨‹
    
- å›åˆ°çº¿ç¨‹æ±  + å›è°ƒåœ°ç‹±
    
- Loom å®Œå…¨å¤±å»æ„ä¹‰
    

---

## å…«ã€ä½ ç°åœ¨åº”è¯¥å½¢æˆçš„æ­£ç¡®å¿ƒæ™ºæ¨¡å‹

### æ­£ç¡®æ¨¡å‹

```text
è™šæ‹Ÿçº¿ç¨‹ = æ‰§è¡ŒçŠ¶æ€ + æ ˆ + Continuation
Executor = OS çº¿ç¨‹èµ„æºæ± 
è°ƒåº¦ = æŠŠæ‰§è¡ŒçŠ¶æ€ä¸´æ—¶â€œæ”¾åˆ°â€ä¸€ä¸ª OS çº¿ç¨‹ä¸Šè·‘
```

### é”™è¯¯æ¨¡å‹ï¼ˆè¯·å½»åº•ä¸¢å¼ƒï¼‰

```text
Executor ç®¡ç†è™šæ‹Ÿçº¿ç¨‹æ± 
Executor æŠŠä»»åŠ¡åˆ†é…ç»™è™šæ‹Ÿçº¿ç¨‹
è™šæ‹Ÿçº¿ç¨‹åƒå¹³å°çº¿ç¨‹ä¸€æ ·å¤ç”¨
```

> **åœ¨ Loom ä¹‹å‰ï¼šçº¿ç¨‹æ˜¯æ‰§è¡Œè€…ï¼Œä»»åŠ¡æ˜¯è¢«è°ƒåº¦çš„å¯¹è±¡**  
> **åœ¨ Loom ä¹‹åï¼šçº¿ç¨‹æœ¬èº«æˆä¸ºè¢«è°ƒåº¦çš„å¯¹è±¡**

è¿™å°±æ˜¯â€œçº¿ç¨‹è°ƒåº¦â€çš„çœŸæ­£å«ä¹‰ã€‚

# â€œè°ƒåº¦çš„æœ¬è´¨â€


> **è™šæ‹Ÿçº¿ç¨‹å¹¶ä¸æ˜¯â€œè¦æ±‚å°½é‡ä¸è¦é˜»å¡â€ï¼Œ  
> è€Œæ˜¯â€œå…è®¸é˜»å¡ï¼Œä½†ä¸èƒ½å ç”¨ OS çº¿ç¨‹â€ã€‚  
> å› æ­¤åœ¨é˜»å¡å‘ç”Ÿæ—¶ï¼Œè™šæ‹Ÿçº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼ˆunmountï¼‰ï¼Œ  
> é˜»å¡è§£é™¤åéœ€è¦é‡æ–°æ‰¾ä¸€ä¸ª OS çº¿ç¨‹ç»§ç»­è¿è¡Œï¼Œ  
> è¿™ä¸ªâ€œæ‰¾ OS çº¿ç¨‹å¹¶å®‰æ’è¿è¡Œâ€çš„è¿‡ç¨‹ï¼Œå°±ç”± Executor å®Œæˆã€‚**

è¿™å°±æ˜¯è°ƒåº¦çš„æœ¬è´¨ã€‚

---

## ä¸€ã€ä¸ºä»€ä¹ˆâ€œä¸æ˜¯å°½é‡ä¸è¦é˜»å¡â€è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Ÿ

### å¦‚æœè™šæ‹Ÿçº¿ç¨‹â€œè¦æ±‚ä¸é˜»å¡â€ï¼Œé‚£å®ƒå°±å¤±è´¥äº†

Loom çš„ç›®æ ‡æ°æ°æ˜¯ï¼š

- ä½ å¯ä»¥ **åƒå†™åŒæ­¥ä»£ç ä¸€æ ·å†™**
    
- å¯ä»¥ **éšä¾¿é˜»å¡**
    
- JVM æ¥æ›¿ä½ å¤„ç†é˜»å¡æˆæœ¬
    

ä¾‹å¦‚ï¼š

```java
try (var socket = new Socket(host, port)) {
    socket.getInputStream().read(); // é˜»å¡
}
```

åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­ï¼š

- âœ” å®Œå…¨åˆæ³•
    
- âœ” é«˜å¹¶å‘å®‰å…¨
    
- âœ” ä¸æµªè´¹ OS çº¿ç¨‹
    

> **é˜»å¡ä¸æ˜¯é—®é¢˜ï¼Œå ç”¨ OS çº¿ç¨‹æ‰æ˜¯é—®é¢˜ã€‚**

---

## äºŒã€Executor åœ¨â€œæŒ‚èµ· / æ¢å¤â€ä¸­çš„çœŸå®è§’è‰²

æˆ‘ä»¬æŠŠå…¨è¿‡ç¨‹å†ç”¨ä¸€æ¡çº¿èµ°ä¸€éï¼Œä½†è¿™æ¬¡åªå…³æ³¨â€œä¸ºä»€ä¹ˆéè¦ Executor ä¸å¯â€ã€‚

---

### 1ï¸âƒ£ è™šæ‹Ÿçº¿ç¨‹è¿è¡Œæ—¶

```text
VirtualThread
   â†“ mount
OS Thread (carrier)
   â†“
æ‰§è¡Œç”¨æˆ·ä»£ç 
```

---

### 2ï¸âƒ£ å‘ç”Ÿé˜»å¡ï¼ˆI/O / park / sleepï¼‰

```text
ç”¨æˆ·ä»£ç 
   â†“
é˜»å¡ç‚¹
```

JVM åšçš„äº‹æƒ…æ˜¯ï¼š

1. **ä¿å­˜è™šæ‹Ÿçº¿ç¨‹çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆContinuationï¼‰**
    
2. **æŠŠè™šæ‹Ÿçº¿ç¨‹ä» OS çº¿ç¨‹ä¸Šâ€œå¸ä¸‹æ¥â€**
    
3. **é‡Šæ”¾ OS çº¿ç¨‹**
    

å…³é”®ç‚¹ï¼š

> æ­¤æ—¶è™šæ‹Ÿçº¿ç¨‹è¿˜æ´»ç€ï¼Œåªæ˜¯â€œæš‚åœâ€ã€‚

---

### 3ï¸âƒ£ é˜»å¡è§£é™¤ï¼ˆI/O ready / unparkï¼‰

ç°åœ¨é—®é¢˜æ¥äº†ï¼š

> **è™šæ‹Ÿçº¿ç¨‹å¦‚ä½•ç»§ç»­è¿è¡Œï¼Ÿ**

å®ƒè‡ªå·±åšä¸åˆ°ï¼Œå› ä¸ºï¼š

- å®ƒæ²¡æœ‰ OS çº¿ç¨‹
    
- å®ƒä¸èƒ½ç›´æ¥æŠ¢ CPU
    

---

### 4ï¸âƒ£ Executor ç™»åœºï¼ˆè°ƒåº¦çš„æœ¬è´¨ï¼‰

JVM åªèƒ½åšä¸€ä»¶äº‹ï¼š

```text
scheduler.execute(virtualThread)
```

å«ä¹‰æ˜¯ï¼š

> **â€œè¯·ä½ ï¼ˆExecutorï¼‰å¸®æˆ‘æ‰¾ä¸€ä¸ªå¯ç”¨çš„ OS çº¿ç¨‹ï¼Œ  
> è®©è¿™ä¸ªè™šæ‹Ÿçº¿ç¨‹ç»§ç»­è·‘ã€‚â€**

Executor çš„èŒè´£åœ¨æ­¤åˆ»éå¸¸æ˜ç¡®ï¼š

- ç®¡ç† OS çº¿ç¨‹
    
- å†³å®šä»€ä¹ˆæ—¶å€™è·‘
    
- å†³å®šåœ¨å“ªä¸ª OS çº¿ç¨‹ä¸Šè·‘
    

---

## ä¸‰ã€ä¸ºä»€ä¹ˆä¸èƒ½â€œç›´æ¥åœ¨ JVM é‡Œè°ƒåº¦â€ï¼Ÿä¸ºä»€ä¹ˆä¸€å®šè¦ Executorï¼Ÿ

è¿™æ˜¯ä½ è¿™ä¸ªé—®é¢˜çš„**æœ€åä¸€å±‚æœ¬è´¨**ã€‚

### åŸå› ä¸æ˜¯â€œæŠ€æœ¯åšä¸åˆ°â€ï¼Œè€Œæ˜¯**è®¾è®¡å¿…ç„¶æ€§**

### 1. Executor æ˜¯ Java ä¸–ç•Œçš„â€œè°ƒåº¦åè®®â€

- çº¿ç¨‹æ± 
    
- ForkJoinPool
    
- Structured Concurrency
    
- CompletableFuture
    

**æ‰€æœ‰å¹¶å‘åŸºç¡€è®¾æ–½éƒ½å›´ç»• Executor**

è™šæ‹Ÿçº¿ç¨‹å¿…é¡»èå…¥è¿™ä¸ªä¸–ç•Œï¼Œè€Œä¸æ˜¯å¦èµ·ç‚‰ç¶ã€‚

---

### 2. Executor æ˜¯ OS çº¿ç¨‹çš„â€œæ‰€æœ‰è€…â€

> **è°åˆ›å»º OS çº¿ç¨‹ï¼Œè°å°±å¿…é¡»è°ƒåº¦å®ƒã€‚**

- JVM ä¸ç›´æ¥ç®¡ç†ä¸šåŠ¡çº¿ç¨‹æ± 
    
- Executor æ‰çŸ¥é“çº¿ç¨‹æ•°é‡ã€é¥¥é¥¿ã€éš”ç¦»ç­–ç•¥
    

---

### 3. Executor æ˜¯â€œç­–ç•¥æ³¨å…¥ç‚¹â€

é€šè¿‡ Executorï¼Œä½ å¯ä»¥æ§åˆ¶ï¼š

- æœ€å¤§å¹¶è¡Œåº¦
    
- èµ„æºéš”ç¦»
    
- è°ƒåº¦ç­–ç•¥
    
- è§‚æµ‹ä¸é™æµ
    

å¦‚æœè™šæ‹Ÿçº¿ç¨‹ç»•è¿‡ Executorï¼Œè¿™ä¸€åˆ‡éƒ½ä¼šå¤±æ•ˆã€‚

---

## å››ã€ç†è§£â€œå®šå‹â€

ä½ ç°åœ¨å¯ä»¥è¿™æ ·æ€»ç»“ï¼ˆè¿™æ˜¯**å®Œå…¨æ­£ç¡®çš„ç‰ˆæœ¬**ï¼‰ï¼š

> **è™šæ‹Ÿçº¿ç¨‹å…è®¸é˜»å¡ï¼Œä½†é˜»å¡æ—¶å¿…é¡»é‡Šæ”¾ OS çº¿ç¨‹ï¼›  
> é˜»å¡è§£é™¤åï¼Œéœ€è¦é‡æ–°æ‰¾ OS çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼›  
> Executor æ­£æ˜¯è´Ÿè´£â€œä¸ºè™šæ‹Ÿçº¿ç¨‹åˆ†é…å’Œè°ƒåº¦ OS çº¿ç¨‹â€çš„ç»„ä»¶ã€‚**

å¦‚æœä½ å·²ç»èƒ½è‡ªç„¶åœ°è¯´å‡ºè¿™å¥è¯ï¼Œè¯´æ˜ä½ å·²ç»**çœŸæ­£ç†è§£äº†è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦å­˜åœ¨çš„æ„ä¹‰**ã€‚

# JDKé»˜è®¤è°ƒåº¦å™¨å®ç°åˆ†æ
å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥å·²ç»è¿›å…¥ **Loom çœŸæ­£çš„â€œè¿è¡Œæ—¶è°ƒåº¦æœºåˆ¶â€** äº†ã€‚ä¸‹é¢ä¼š**ä¸¥æ ¼å›´ç»• JDK 21 çš„ `DEFAULT_SCHEDULER`**ï¼ŒæŒ‰ _æ˜¯ä»€ä¹ˆ â†’ æ€ä¹ˆè°ƒåº¦ â†’ å‘ç”Ÿé˜»å¡æ—¶å¦‚ä½•æµè½¬_ çš„é¡ºåºè¯´æ˜ï¼Œå¹¶åœ¨æœ€åç»™ä¸€ä¸ª**å®Œæ•´ã€å¯å¯¹ç…§æºç çš„æµç¨‹å›¾**ã€‚

---

## ä¸€ã€`DEFAULT_SCHEDULER` æ˜¯ä»€ä¹ˆï¼ˆç²¾ç¡®å®šä¹‰ï¼‰

åœ¨ JDK 21 ä¸­ï¼š

> **`DEFAULT_SCHEDULER` æ˜¯ä¸€ä¸ªç”± JVM åˆ›å»ºå¹¶æŒæœ‰çš„ã€ä¸“é—¨ç”¨äºè°ƒåº¦è™šæ‹Ÿçº¿ç¨‹çš„ `ForkJoinPool`ã€‚**

å®ƒçš„èŒè´£åªæœ‰ä¸€ä¸ªï¼š

> **ä¸ºè™šæ‹Ÿçº¿ç¨‹æä¾›å¯è¿è¡Œæ—¶æ‰€éœ€çš„ OS çº¿ç¨‹ï¼ˆCarrier Threadï¼‰å¹¶è°ƒåº¦å…¶æ‰§è¡Œã€‚**

æ³¨æ„ä¸‰ä¸ªå…³é”®è¯ï¼š

- **ä¸æ˜¯**åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹
    
- **ä¸æ˜¯**ç®¡ç†è™šæ‹Ÿçº¿ç¨‹æ•°é‡
    
- **åªè´Ÿè´£**è°ƒåº¦è™šæ‹Ÿçº¿ç¨‹â€œä»€ä¹ˆæ—¶å€™ã€åœ¨å“ªä¸ª OS çº¿ç¨‹ä¸Šè·‘â€
    

---

## äºŒã€`DEFAULT_SCHEDULER` çš„å…³é”®é…ç½®ç‰¹å¾

é€»è¾‘ä¸Šå¯ä»¥ç†è§£ä¸ºï¼š

```text
ForkJoinPool (VirtualThreadScheduler)
â”œâ”€ parallelism â‰ˆ CPU æ ¸æ•°
â”œâ”€ asyncMode = true (FIFO)
â”œâ”€ worker threads = ForkJoinWorkerThread (carrier)
â””â”€ JVM æ·±åº¦æ„ŸçŸ¥ï¼ˆvirtual-thread-awareï¼‰
```

è¿™äº›é…ç½®å†³å®šäº†å®ƒçš„**è°ƒåº¦è¯­ä¹‰**ï¼š

- **ä¸è¿½æ±‚ CPU å¯†é›†åå**
    
- **ä¼˜å…ˆå…¬å¹³ã€å¿«é€Ÿæ¢å¤**
    
- **æåº¦é¢‘ç¹çš„ park / unpark å‹å¥½**
    

---

## ä¸‰ã€DEFAULT_SCHEDULER è°ƒåº¦çš„â€œå¯¹è±¡â€æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™æ˜¯ç†è§£æµç¨‹å›¾å‰å¿…é¡»å†æ¬¡ç¡®è®¤çš„ä¸€ç‚¹ï¼š

> **è¢«è°ƒåº¦çš„å¯¹è±¡æ˜¯ï¼š`VirtualThread` å®ä¾‹æœ¬èº«ï¼ˆå®ƒå®ç°äº† `Runnable`ï¼‰**

ä¸æ˜¯ä¸šåŠ¡ `Runnable`ï¼Œä¸æ˜¯ `Callable`ï¼Œè€Œæ˜¯ï¼š

```java
class VirtualThread implements Runnable
```

---

## å››ã€æ­£å¸¸æ‰§è¡Œè·¯å¾„ï¼ˆæ— é˜»å¡ï¼‰

### 1ï¸âƒ£ åˆ›å»ºå¹¶å¯åŠ¨è™šæ‹Ÿçº¿ç¨‹

```java
Thread.startVirtualThread(task);
```

JVM å†…éƒ¨é€»è¾‘ï¼ˆç®€åŒ–ï¼‰ï¼š

```text
new VirtualThread(task, DEFAULT_SCHEDULER)
â†“
DEFAULT_SCHEDULER.execute(virtualThread)
```

---

### 2ï¸âƒ£ DEFAULT_SCHEDULER æ¥æ”¶ä»»åŠ¡

```text
ForkJoinPool
â†“
å°† virtualThread æ”¾å…¥æŸä¸ª worker çš„ä»»åŠ¡é˜Ÿåˆ—
```

---

### 3ï¸âƒ£ Carrier Thread æ‰§è¡Œ

```text
ForkJoinWorkerThread (OS Thread)
â†“
virtualThread.run()
â†“
Continuation.run()
â†“
æ‰§è¡Œç”¨æˆ·ä»£ç 
```

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œä¸€åˆ‡å’Œâ€œæ™®é€š Runnableâ€çœ‹èµ·æ¥å‡ ä¹ä¸€æ ·ã€‚

---

## äº”ã€å‘ç”Ÿé˜»å¡æ—¶ï¼šè°ƒåº¦é€»è¾‘çš„æ ¸å¿ƒä»·å€¼

ç°åœ¨è¿›å…¥ä½ çœŸæ­£å…³å¿ƒçš„éƒ¨åˆ†ã€‚

---

### å…³é”®å‰æ

é˜»å¡ç±»å‹åŒ…æ‹¬ï¼š

- I/Oï¼ˆsocket / file / selectorï¼‰
    
- `LockSupport.park`
    
- `sleep`
    
- monitor ç«äº‰ï¼ˆéƒ¨åˆ†æƒ…å†µï¼‰
    

---

## å…­ã€DEFAULT_SCHEDULER çš„å®Œæ•´è°ƒåº¦æµç¨‹å›¾ï¼ˆé‡ç‚¹ï¼‰

ä¸‹é¢è¿™ä¸ªæµç¨‹å›¾ä½ å¯ä»¥å½“ä½œ **â€œè™šæ‹Ÿçº¿ç¨‹è°ƒåº¦çš„å¿ƒæ™ºæ¨¡å‹å®šç¨¿ç‰ˆâ€**ã€‚

---

### ğŸŒ è™šæ‹Ÿçº¿ç¨‹ + DEFAULT_SCHEDULER è°ƒåº¦æµç¨‹å›¾

```mermaid
flowchart TD
    A[Thread.startVirtualThread] --> B[åˆ›å»º VirtualThread å¯¹è±¡<br/>- ç‹¬ç«‹æ ˆ<br/>- Continuation<br/>- scheduler = DEFAULT]
    B --> C["DEFAULT_SCHEDULER.execute<br/>(æäº¤ VirtualThread)"]
    C --> D["ForkJoinWorkerThread<br/>(Carrier OS Thread)"]
    D --> E["VirtualThread.run()<br/>â†’ Continuation.run()<br/>â†’ ç”¨æˆ·ä»£ç "]

    E --> F{æ˜¯å¦å‘ç”Ÿé˜»å¡ï¼Ÿ}

    F -->|å¦| G[æ­£å¸¸æ‰§è¡Œ<br/>ç»§ç»­è¿è¡Œ]
    G --> E

    F -->|æ˜¯| H[ä¿å­˜ Continuation<br/>VirtualThread unmount]
    H --> I[é‡Šæ”¾ Carrier Thread<br/>è¿”å› ForkJoinPool]
    I --> J[è™šæ‹Ÿçº¿ç¨‹è¿›å…¥ç­‰å¾…æ€]
    J -->|I/O å®Œæˆ / unpark| K["DEFAULT_SCHEDULER.execute<br/>(virtualThread)"]
    K --> L[æ–° / ç©ºé—² Carrier Thread<br/>è·å–æ‰§è¡Œæƒ]
    L --> E

```

---

## ä¸ƒã€ä¸ºä»€ä¹ˆ DEFAULT_SCHEDULER å¿…é¡»æ˜¯ ForkJoinPoolï¼Ÿ

ä»æµç¨‹å›¾ä½ å¯ä»¥æ¸…æ¥šçœ‹åˆ°ï¼Œå®ƒå¿…é¡»å…·å¤‡è¿™äº›èƒ½åŠ›ï¼š

1. **é«˜é¢‘ submit / execute**
    
2. **æä½æˆæœ¬çš„çº¿ç¨‹åˆ‡æ¢**
    
3. **OS çº¿ç¨‹å¤ç”¨**
    
4. **é˜»å¡æ„ŸçŸ¥ & è¡¥å¿èƒ½åŠ›**
    
5. **ä¸ JVM safepoint / GC ååŒ**
    

ç›®å‰ **åªæœ‰ ForkJoinPool æ»¡è¶³å…¨éƒ¨æ¡ä»¶**ï¼Œè€Œä¸” JVM å·²ç»ä¸ºå®ƒåšäº† Loom çº§åˆ«çš„å¢å¼ºã€‚

---

## å…«ã€ä¸€å¥è¯æ€»ç»“ DEFAULT_SCHEDULER çš„è°ƒåº¦é€»è¾‘

ä½ ç°åœ¨å¯ä»¥è¿™æ ·å‡†ç¡®åœ°æè¿°å®ƒï¼š

> **DEFAULT_SCHEDULER æ˜¯ä¸€ä¸ªä¸“ç”¨çš„ ForkJoinPoolï¼Œå®ƒåå¤æ‰§è¡Œä»¥ä¸‹å¾ªç¯ï¼š  
> æŠŠè™šæ‹Ÿçº¿ç¨‹å½“ä½œä»»åŠ¡è°ƒåº¦åˆ° OS çº¿ç¨‹ä¸Šè¿è¡Œï¼›  
> ä¸€æ—¦è™šæ‹Ÿçº¿ç¨‹é˜»å¡ï¼Œå°±ç«‹å³é‡Šæ”¾ OS çº¿ç¨‹ï¼›  
> é˜»å¡è§£é™¤åï¼Œå†æ¬¡è°ƒåº¦è¯¥è™šæ‹Ÿçº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚**

# éªŒè¯è™šæ‹Ÿçº¿ç¨‹çš„åˆ‡æ¢
```java
import java.time.Duration;
import java.util.concurrent.Executors;
import java.util.stream.IntStream;

public class VirtualThreadCarrierSwitch {

    public static void main(String[] args) {
        // ä½¿ç”¨ Java 21 çš„ try-with-resources è¯­æ³•è‡ªåŠ¨å…³é—­ Executor
        // è¿™ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•
        try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
            
            // å¯åŠ¨ 5 ä¸ªè™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡
            IntStream.range(0, 5).forEach(i -> {
                executor.submit(() -> {
                    // 1. è·å–é˜»å¡å‰çš„ Carrier çº¿ç¨‹ä¿¡æ¯
                    String before = getCarrierThreadName();
                    
                    System.out.printf("ä»»åŠ¡ #%d [é˜»å¡å‰] è¿è¡Œåœ¨: %s%n", i, before);

                    try {
                        // 2. æ‰§è¡Œé˜»å¡æ“ä½œ (Sleep 50ms)
                        // æ­¤æ—¶è™šæ‹Ÿçº¿ç¨‹ä¼šä» Carrier Thread ä¸Šå¸è½½ (Unmount)
                        Thread.sleep(Duration.ofMillis(50)); 
                    } catch (InterruptedException e) {
                        Thread.currentThread().interrupt();
                    }

                    // 3. è·å–é˜»å¡åçš„ Carrier çº¿ç¨‹ä¿¡æ¯
                    // æ­¤æ—¶è™šæ‹Ÿçº¿ç¨‹å·²é‡æ–°æŒ‚è½½ (Remount)ï¼Œå¯èƒ½åœ¨ä¸åŒçš„ Worker ä¸Š
                    String after = getCarrierThreadName();
                    
                    System.out.printf("ä»»åŠ¡ #%d [é˜»å¡å] è¿è¡Œåœ¨: %s%n", i, after);
                    
                    // 4. æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†åˆ‡æ¢
                    if (!before.equals(after)) {
                        System.out.printf(">>> ğŸ’¥ è§‚å¯Ÿåˆ°åˆ‡æ¢! ä»»åŠ¡ #%d ä» [%s] åˆ‡æ¢åˆ°äº† [%s]%n", i, before, after);
                    } else {
                        System.out.printf(">>> ä»»åŠ¡ #%d æ²¡æœ‰åˆ‡æ¢ Carrier (å±äºè¿æ°”æˆ–è°ƒåº¦ä¼˜åŒ–)%n", i);
                    }
                });
            });
        }
    }

    /**
     * è¾…åŠ©æ–¹æ³•ï¼šä» Thread.toString() ä¸­æå– Carrier Thread çš„åç§°ã€‚
     * è™šæ‹Ÿçº¿ç¨‹çš„ toString() æ ¼å¼é€šå¸¸ä¸º: 
     * VirtualThread[#21]/runnable@ForkJoinPool-1-worker-1
     * æˆ‘ä»¬éœ€è¦ "@" åé¢çš„éƒ¨åˆ†ã€‚
     */
    private static String getCarrierThreadName() {
        String threadString = Thread.currentThread().toString();
        int atIndex = threadString.indexOf("@");
        if (atIndex != -1) {
            return threadString.substring(atIndex + 1);
        }
        return "Unknown";
    }
}
```
